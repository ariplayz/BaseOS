
name: Build BaseOS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Install required tools
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make xorriso ovmf wget tar dosfstools mtools

      # Download and build gnu-efi
      - name: Build and install gnu-efi
        run: |
          wget https://psychz.dl.sourceforge.net/project/gnu-efi/gnu-efi-3.0.18.tar.bz2
          tar -xvjf gnu-efi-3.0.18.tar.bz2
          cd gnu-efi-3.0.18
          make
          sudo make install
          cd ..

      # Set environment variables
      - name: Set environment variables
        run: |
          echo "BUILD_PATH=build" >> $GITHUB_ENV
          echo "RUN_PATH=build/qemu" >> $GITHUB_ENV
          echo "OVMF_DISK_IMG=/usr/share/ovmf/OVMF.fd" >> $GITHUB_ENV

      # Clean previous build
      - name: Clean previous build
        run: rm -rf $BUILD_PATH

      # Build EFI binary
      - name: Build EFI binary
        run: |
          mkdir -p $BUILD_PATH
          cd $BUILD_PATH
          cmake ..
          make
          cd ..

      # Create bootable ISO with FAT EFI image
      - name: Create bootable ISO
        run: |
          set -e
          BINARY_PATH=$BUILD_PATH/cppefi.efi
          ISO_ROOT=$RUN_PATH/iso
          EFI_IMG=$RUN_PATH/efiboot.img
          ISO_FILE=$RUN_PATH/uefi.iso

          mkdir -p $RUN_PATH $ISO_ROOT

          if [ ! -f "$BINARY_PATH" ]; then
            echo "ERROR: EFI binary not found at $BINARY_PATH"
            exit 1
          fi

          echo "[+] Creating EFI boot image..."
          dd if=/dev/zero of=$EFI_IMG bs=1M count=10
          mkfs.vfat $EFI_IMG
          mmd -i $EFI_IMG ::/EFI ::/EFI/BOOT
          mcopy -i $EFI_IMG $BINARY_PATH ::/EFI/BOOT/BOOTX64.EFI

          echo "EFI\\BOOT\\BOOTX64.EFI" > $ISO_ROOT/startup.nsh

          mv $EFI_IMG $ISO_ROOT/efiboot.img

          echo "[+] Creating bootable ISO..."
          xorriso -as mkisofs \
            -o $ISO_FILE \
            -iso-level 3 \
            -full-iso9660-filenames \
            -eltorito-alt-boot \
            -e efiboot.img \
            -no-emul-boot \
            $ISO_ROOT

          mkdir -p bin
          cp $ISO_FILE bin/BaseOS.iso

      # Upload ISO artifact
      - name: Upload BaseOS ISO
        uses: actions/upload-artifact@v4
        with:
          name: BaseOS.iso
          path: bin/BaseOS.iso
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
          include-hidden-files: false
